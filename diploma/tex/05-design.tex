\chapter{Конструкторский раздел}

В данном разделе описывается разработанный метод и особенности разработанного метода; формулируются и описываются ключевые шаги метода в виде схем алгоритом; описываются структуры данных, используемые в алгоритмах, и взаимодействие отдельных частей системы.

\section{Разработанный метод}

Разработанный метод основывается на методе, анализирующий гистограмму изображения окружения, но в отличие от него учитывает глубину окружения \cite{osti2019real}.

Метод состоит из 5 основных этапов:

\begin{enumerate}
	\item[---] захват изображения;
	\item[---] обработка изображения;
	\item[---] поиск положения источников света;
	\item[---] построение геометрии окружения;
	\item[---] отрисовка теней.
\end{enumerate}

\subsection{Особенности метода}

В этом методе в качестве исходных данных используется информация о глобальном освещении окружающей среды и любых источниках света, присутствующих вокруг пользователя, из HDR-изображений. Исходные изображения должны обладать следующими свойствами:

\begin{itemize}
	\item[---] они должны быть всенаправленными, т.е. для каждого направления пространства имеется пиксель, представляющий это направление;
	\item[---] значения пикселей соответствуют количеству света, поступающего с этого направления.
\end{itemize}

\subsection{Захват изображения}

На основе исходных снимков создается т. н. карта сферы, которая представляет собой сферическое изображение на 360 градусов окружения, где будут размещены синтетические объекты. Чтобы удовлетворить свойству всенаправленности, наиболее часто используемым методом является фотографирование зеркальной сферы: этот метод позволяет получать свет, исходящий из-за сферы, поскольку лучи за сферой отклоняются и захватываются камерой спереди. Более простой метод состоит в том, чтобы сделать несколько фотографий всего окружения и скомпоновать их вместе, накладывая друг на друга, чтобы сформировать карту сферы \cite{osti2019real}.

\subsection{Обработка изображения}

Полученную карту сферы конвертируется из RGB-изображения в изображение в оттенках серого для более простого применения порогового значения к значениям цвета пикселей, поскольку в изображении в оттенках серого они варьируются только от 0 до 255. Стоит отметить, что не все RGB-изображения после конвертировании в изображение в оттенках серого имеют пиксели, которые варьируются от 0 до 255. Например, слишком яркие или слишком тусклые изображения.

После преобразования изображения можно применить для него пороговое значение, чтобы удалить все пиксели со значением цвета ниже заданного порога. Этот порог выбирается путем анализа гистограммы изображения \cite{img_hists}.

Далее проверяется следующее условие:

\begin{equation}
	\frac{\text{max}(\text{PixelValue})}{\text{average}(\text{PixelValue})} \geq 1.5,
\end{equation}

где PixelValue -- значение пикселя, max(PixelValue) -- максимальное значение пикселя, average(PixelValue) -- среднее значение пикселя.

Если это условие верно, то это означает, что разница между максимальным значением и средним значением пикселей достаточно, чтобы утверждать, что существует видимая разница между окружающим светом и возможным точечным светом. В ином случае возможно ошибочное отождествление окружающего света с точечным светом, что приводит, во-первых, к слишком высокой плотности белых пикселей и, во-вторых, к неточному расположению света на этапе поиска положения источников света \cite{osti2019real}.

Далее происходит оценка порогового значения. Если 93\% спектра (начиная с 0) покрывают не менее 98\% пикселей, то можно отбросить оставшиеся 7\%. Этот шаг позволяет обрезать изображение и рассматривать только те области изображения, которые соответствуют реальным ИС. Полученный результат обрабатывается медианным фильтром размытия в качестве метода шумоподавления, поскольку возможно наличие некоторых областей со значением пикселей выше порогового значения из-за отражений объектов в окружающей среде \cite{osti2019real}.

\subsection{Поиск положения источников света}

У полученного изображения вычисляются контуры ИС. Из полученных контуров определяются моменты контуров, из которых можно получить центроиды каждого ИС. 

Моменты изображения представляют собой средневзвешенное значение интенсивности пикселей изображения, то есть это суммарная характеристика контура, рассчитанная интегрированием (суммированием) всех пикселей контура. Все что необходимо -- это вычислить сумму интенсивностей всех пикселей и получить на выходе значение \cite{sns_tras}.

Из координат центроида на изображении окружения $(x_{pixel}, y_{pixel})$ можно получить зенит $\theta$ и азимут $\phi$ ИС на сферической карте следующим образом. Координата $x_{pixel}$ пропорциональна зениту, а координата $y_{pixel}$ пропорциональна азимуту, из чего следуют соотношения \cite{osti2019real}:

\begin{equation}
	\begin{aligned}
		\begin{split}
			\frac{x_{\text{pixel}}}{\theta} &= \frac{\text{width}}{2\pi}, \\
			\frac{\text{height} - y_{\text{pixel}}}{\phi} &= \frac{\text{height}}{\pi}, 
		\end{split}
	\end{aligned}
\end{equation}

где width, height -- ширина и высота исходного изображения окружения соответственно. Стоит отметить, что координата $r$ у ИС равна глубине пикселя карты с координатами $(x_{pixel}, y_{pixel})$, т. е. 

\begin{equation}
	r = depth[x_{pixel}, y_{pixel}],
\end{equation}
 
где $depth$ -- двухмерный массив, хранящий информацию о глубине каждого пикселя карты сферы.

Зная значения координат ИС в сферических координатах, можно их перевести в декартову систему координат:

\begin{equation}
	\begin{aligned}
		\begin{split}
			x &= r \sin\theta \cos\phi, &&\\
			y &= r \sin\theta \sin\phi, &&\\
			z &= r \cos\phi. &&\\
		\end{split}
	\end{aligned}
\end{equation}

Таким образом, становится известно положение ИС в трехмерном пространстве.

\subsection{Построение геометрии окружения}



\subsection{Отрисовка теней}

Отрисовка теней происходит по алгоритмам машинной графики. Зная местоположение каждого ИС, расставляются их виртуальные аналоги. В итоге происходит синтез и отображение виртуальной сцены с виртуальным объектом, отбрасывающим тень от <<реальных>> ИС.

\section{Структуры данных}



\section{Взаимодействие отдельных частей системы}

