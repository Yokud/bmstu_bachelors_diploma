\chapter{Аналитический раздел}

В данном разделе изучается предметная область, описываются основные определения ДР, компьютерного зрения и наложения теней, проводится обзор существующих методов получения данных о глубине окружения и способов построения теней на основе информации о глубине точек кадра. Также проводится сравнение методов между собой и формализация задачи в виде IDEF0-диаграммы.

\section{Анализ предметной области}

\subsection*{Дополненная реальность и компьютерное зрение}

\textit{Дополненная реальность} -- технология интеграции цифровой информации в виде изображений компьютерной графики, текста, видео, и другой информации и изображений объектов действительного (физического) мира в режиме реального времени \cite{tech-ar}.

\textit{Компьютерное зрение} -- теория и технология создания машин, которые могут производить обнаружение, слежение и классификацию объектов \cite{comp_vision}. 

Технология ДР полагается на теорию компьютерного зрения, а точнее на анализ и обработку изображений. В области ДР алгоритмы компьютерного зрения используются для поиска в видеопотоке специальных маркеров или точек интереса. Алгоритмы компьютерного зрения позволяют выделять ключевые особенности на изображении (границы области, углы), производить поиск объектов в реальном времени и многое другое. После нахождения маркеров или точек интереса в видеопотоке и вычислении их местоположения, появляется возможность построения матрицы проекции и позиционирования виртуальных моделей. С помощью матриц проекции и позиционирования можно наложить виртуальный объект на видеопоток таким образом, что будет достигнут эффект присутствия \cite{tech-ar}.

\subsection*{Данные об окружении}

При наложении теней в качестве исходных данных используются RGBD-изображения \cite{debevec2008rendering} \cite{sns_tras}.

\textit{RGBD-изображение} -- изображение, в котором каждый его пиксель помимо информации о цвете хранит информацию и о глубине \cite{rgbd}. Существует несколько способов получения информации о глубине точек кадра:

\begin{itemize}
	\item[---] структурированный свет;
	\item[---] стереокамера;
	\item[---] время полета (также Time-of-Flight);
	\item[---] лидар (также LIDAR или LiDAR);
\end{itemize}

\subsubsection*{Структурированный свет}

Данный способ полагается на проектор света, который проецирует шаблоны на реальные объекты. В качестве шаблонов могут быть точка, линия, полоса определенной толщины и регулярная сетка. Однако первые три шаблона требуют поворота проектора хотя бы по одной оси для сканирования всей области, поэтому обычно используют регулярную сетку, для которой этого не требуется \cite{struct_light}. 

Для проектора ипользуется инфракрасный свет для минимизации помех. На основе искажения шаблона можно восстановить информацию о глубине с помощью паралакса, зная положение проектора в системе координат камеры. Большинство датчиков структурированного света не работают под прямыми лучами солнца, поскольку они полагаются на проекцию света в сцене. Поэтому они обычно подходят для использования в помещениях \cite{struct_light}.

\subsubsection*{Стереокамера}

Данный способ схож со структурированным светом, но отличается использованием еще одной камеры вместо проектора. Зная положения проекций одной и той же точки на изображения камер, и расстояние между камерами, можно вычислить глубину этой точки на основе паралакса. Стереокамеры работают как в помещении, так и на открытом воздухе. Проблемы же у данного способа возникают при анализе глубины точек гладкой окрашенной стены, так как изображения на обеих камерах эквивалентны. \cite{rgbd}.

\subsubsection*{Время полета}

Данный способ основан на оценке расстояния от датчика до наблюдаемого объекта путем измерения времени, необходимого для приема датчиком излучаемого света, отраженного от объекта. Поэтому датчики используют модуляцию излучаемого светового сигнала и сравнивают изменение фазы выпущенного сигнала и отраженного. Концепция практически не отличается от ультразвуковых и радарных датчиков, но здесь в качестве излучаемого сигнала используется свет. При сильном солнечном свете датчик может давать сбои, поэтому данный способ также чаще всего используют в помещениях \cite{rgbd}.

\subsubsection*{Лидар}

Данный способ использует идею измерения времени движения света, в течение которого излучаемый свет принимается датчиком, но они полагаются на один или несколько лазерных лучей (концентрированный свет) для измерения глубины точек в сцене. Лидарный датчик полагается на сфокусированные лазерные лучи, которые позволяют проводить измерения расстояния до нескольких километров. Точность измерений обычно не зависит от расстояния, хотя может зависеть от погодных условий: при неблагоприятных условия, например, густой туман и бурный снегопад, она может падать. Лидарные датчики излучают свет, поэтому они работают в сложных условиях освещения, например, при недостатке освещения. Они подходят для использования в помещениях и на открытом воздухе \cite{rgbd}.

\subsection*{Построение тени}

Тень состоит из двух частей: полутени и полной тени. Полная тень -- центральная, темная, резко отчерченная часть, а полутень (или мягкая тень) -- окружающая ее более светлая часть. Полная тень образуется при полном отсутствии света, а полутень освещается частью рассеянного света ИС \cite{rogers}.

Существует несколько способов построения теней:

\begin{itemize}
	\item[---] использование теневой карты;
	\item[---] построение теневого объема;
	\item[---] обратная трассировка лучей.
\end{itemize}

\subsubsection*{Теневая карта}

Теневая карта -- объект, хранящий информацию о затененных пикселях буфера кадра. Основная идея использования теневой карты -- построение карты глубины с точки зрения ИС и сравнение с картой глубины виртуальной камеры: те пиксели, которые видны с точки зрения камеры, но не видны с точки зрения ИС, являются затененными. Этот процесс называется \textit{теневым тестом}. Такой подход не требователен к вычислительным ресурсам, но требователен к памяти, поскольку теневая карта обладает тем же разрешением, что и конечное изображение, и таких карт может быть несколько в зависимости от количества ИС \cite{engel2008programming}.

\subsubsection*{Теневой объем}

Теневой объем -- это область пространства, доступ света в которую закрывает объект. Боковые границы теневого объема образуются четырехугольниками, расположенными от границ объекта, направленных на ИС, до некоторой пересекающейся с теневым объемом плоскостью. Границы ближнего к источнику основания четырехугольника образуются так называемыми границами силуэта. Эти границы образуются сторонами треугольников, находящимися на границе затененной и освещенной областей объекта или рядом с ней. В общем случае граница силуэта пролегает по границе между треугольниками, один из которых обращен к источнику света, а другой -- в обратную сторону. Чтобы получить теневой объем, нужно найти все границы силуэта и нарисовать четырехугольники для каждой из них. Границы же дальнего основания образуются границами пересечения теневого объема с ближайщей к ИС плоскостью \cite{shad_vol}.

Освещенность точки определяется следующим образом: от точки местоположения камеры до нее проводится луч, который связан со счетчиком прохождения граней теневого объема. При входе в грань теневого объема счетчик увеличивается, при выходе -- уменьшается. В итоге, если счетчик больше нуля, то точка считается затененной, иначе -- она освещена.

Такой подход может давать ложные результаты, если камера находится внутри теневого объема. Эта проблема устраняется решением обратной задачи -- трассировкой лучей из бесконечности к точке местоположения камеры \cite{shad_vol}.

\subsubsection*{Обратная трассировка лучей}

Обратная трассировка лучей -- это метод оценки освещенности, при котором для каждого пикселя в буфере кадра луч, выпущенный из пикселя, сталкивается с объектами сцены, чтобы определить отраженный цвет объекта. Луч может быть прослежен дальше, после первого столкновения с некоторым объектом, для создания эффектов, подобных зеркалу или стеклу. Тени с трассировкой лучей оцениваются аналогично оценке отражённого объектом света, но вместо оценки столкновения лучей из буфера кадра со сценой проверка столкновения выполняется для лучей от сцены к источнику света. Если луч от текущего пикселя столкнется с каким-либо объектом до того, как достигнет источника света, текущий пиксель окажется в тени, и, таким образом, его цвет будет темнее по сравнению с основным цветом его материала \cite{engel2008programming}.

\section{Методы наложения теней в дополненной реальности}

Существует несколько методов наложения теней, использующие информацию о глубине точек кадра:

\begin{itemize}
	\item[---] метод на основе анализа контуров теней ИС;
	\item[---] метод на основе построения теневых объемов;
	\item[---] метод с использованием сверточных нейронных сетей и трассировки теневых лучей.
\end{itemize}

\subsection{Метод на основе анализа контуров теней}

В качестве исходных данных используются RGBD-изображения.

Из исходных данных вычисляется следующий набор данных: точки, соответствующие границам объектов, и точки, соответствующие границам теней от объектов. Предполагается, что имеется прямое соответствие между объектами и их тенями на RGBD-изображении. Количество найденных точек практически не сказывается на точности, но они должны быть расположены равномерно по контуру изображения объекта, и отклонение точек от границы контура не должно быть значительным. Количество точек на контурах объектов и их теней не должно быть меньше 3 \cite{shadow_contours_method}.

Полученные наборы точек используются для нахождения положений ИС следующим образом. 

\begin{enumerate}
	\item Строится набор плоскостей параллельно поверхности земли.
	\item Из точек на границах тени выпускают лучи через сопряженные точки на границах объекта. Эти лучи пересекают ранее построенные плоскости, тем самым итеративно получают точки пересечения лучей с плоскостями.
	\item Проверяется характер распределения скоплений этих точек пересечения на каждой плоскости. Скопление точек, полученное данным методом, уплотняется при приближении виртуальной плоскости к ИС. На определенном шаге итераций скопление точек перестанет уплотняться и в дальнейшем будет расширяться. Максимальная плотность скопления свидетельствует о том, что следующая плоскость находится дальше от источника, чем текущая. А источник расположен между этой и следующей плоскостями.
	\item После этого определяется центры скоплений этих точек. Зная высоту найденной виртуальной плоскости и центры скоплений, можно восстановить положения ИС.	При этом абсолютная ошибка определения координаты ИС по высоте не превышает половины шага, с которым чередуются виртуальные плоскости  \cite{shadow_contours_method}.
	\item Далее уточняются координаты ИС с помощью билинейной интерполяции между двумя виртуальными плоскостями с максимальной плотностью точек.
\end{enumerate}

Также стоит упомянуть случай, когда не был найден ни один ИС. Это может происходить, например, если объекты и их тени были некорректно согласованы или видимый край объекта не является краем, создающим тень \cite{shadow_contours_method}.

Поскольку ограничением данного метода является невозможность восстановить интенсивность и диаграмму излучения ИС, то тип найденного ИС устанавливается точечным, а диаграмма излучения -- Ламбертовой \cite{shadow_contours_method}.

\subsubsection*{Преимущества и недостатки}

Преимуществами данного метода являются:

\begin{itemize}
	\item[---] работа в помещении;
	\item[---] возможность распознать несколько ИС. 
\end{itemize}

Недостатками данного метода являются:

\begin{itemize}
	\item[---] зависимость качества его работы от результатов распознавания контуров объектов и теней. Устройство распознавания может распознать только часть контуров, например, распознанная часть тени может не соответствовать обнаруженному контуру объекта.
\end{itemize}

\subsection{Метод на основе построения теневых объемов}

Данный метод состоит из трех этапов.

\begin{enumerate}
	\item Обнаружение теней на видео в реальном времени.
	\item Построение теневого объема.
	\item Отрисовка виртуального объекта и синтез изображения.
\end{enumerate}

В качестве исходных данных используются RGBD-изображения.

В методе текущий, то есть $k$-й, кадр видео разделяется на две области: область проекции и новую область. 

Предыдущий, то есть $k-1$-й, кадр видео проецируется на $k$-й кадр с оцененной позиции камеры и с использованием информации о глубине точек кадра. Область, которая являестя результатом пересечения двух кадров, называется областью проекции. Новая область -- область $k$-го кадра, не попавшая в область проекции, то есть разность между областью проекции и $k$-м кадром. Далее фильтруются данные глубины кадра от шумов и оценивается положение камеры. Затем происходит обнаружение граней новых теней в новой области, и грани новых теней добавляются к старым. 

На основе обнаруженных граней теней строится теневой объем и уточняется с помощью адаптивной стратегии выборки \cite{THOMASIAN2022385} для достижения плавных эффектов отбрасывания теней.

В итоге происходит синтез и отображение конечного изображения с виртуальным объектом.

\subsubsection*{Обнаружение теней на видео в реальном времени}

Поиск теней происходит в пространстве изображения. 

Большая часть теней распределена по всей области проекции. В этой области грани тени кадра $k$ могут быть непосредственно спроецированы из кадра $k - 1$. Чтобы устранить ошибки проецирования, вызванные зашумленными параметрами камеры и данными о глубине, происходит оптимизация первоначально спроецированных граней тени в области проецирования. Грани тени в новой области обнаруживаются и объединяются с гранями теней из области проекции путем обеспечения плавности перехода между гранями теней из области проекции и гранями теней из новой области \cite{wei2019simulating}.

\paragraph*{Область проекции} 
""\newline\indent
Для оптимизации контуров теней используется алгоритм Кэнни. К полученным результатам применяют фильтрацию среднего сдвига чтобы сгладить контуры теней и избежать влияния мягких теней и шума изображения. Затем пиксель на грани тени, для которого отношение интенсивности двух сторон его направления градиента превышает заданный порог (0.65 от темной стороны к светлой стороне), идентифицируется как находящийся на краю тени. Далее происходит объединение пикселей изначального контура теней с пикселями контуров теней, полученных после оптимизации, путем поиска пикселей граней теней в небольшой окрестности (3 на 3 пикселя) каждого пикселя изначального контура теней. Если в окрестности появляется пиксель контура тени после оптимизации, то он заменяет пиксель изначального контура тени \cite{wei2019simulating}.

\paragraph*{Новая область} 
""\newline\indent
Изображение представляет собой попиксельное произведение освещенности и коэффициента отражения: 

\begin{equation}
	I(x) = R(x)L(x), 
\end{equation}

где $I(x)$ -- наблюдаемый цвет RGB в пикселе $x$, а $L(x)$ и $R(x)$ -- освещенность и коэффициент отражения (альбедо). Для пикселей $p$ и $q$, которые находятся в теневой и не теневой областях соответственно и на небольшом расстоянии от пикселя $x$ (3 на 3 пикселя), интенсивности изображения следующие:

\begin{equation}
	\begin{aligned}
		\begin{split}
			I(p) &= R(p)(L_{sun} \cos(\theta) + L_{sky}) &&\\
			I(q) &= R(q)L_{sky}, &&
		\end{split}
	\end{aligned}
\end{equation}

где $L_{sun}$ -- интенсивность солнечного света, $L_{sky}$ -- интенсивность рассеянного света, то есть неба.

Так как пиксели $p$ и $q$ примыкают к границе тени, то предполагается, что они имеют одинаковую отражательную способность, то есть $R(p) \approx R(q)$, из чего следует, что:

\begin{equation}
	\frac{I(p)}{I(q)} \approx \frac{L_{sun} \cos(\theta) + L_{sky}}{L_{sky}} = 1 + \cos(\theta)\frac{L_{sun}}{L_{sky}},
\end{equation}

где $\theta$ -- угол падения между направлением солнечного света и нормалью к поверхности в пикселе $p$.

Для пикселей с известными нормальными направлениями или плоских пикселей, то есть пикселей без информации о глубине, вычисляется отношение $r = \frac{L_{sun}}{L_{sky}}$. Для каждого пикселя $x$ на гранях тени в области проекции вычисляется $r(x)$ . Затем вычисляется усредненное соотношение по всем пикселям на гранях тени в области проекции и обозначается как $r_s$.

В новой области грани тени вычисляются теми же методами, что и в области проекции, но каждая точка грани подвергается анализу: используется пространственное расстояние между пикселем $y$ и краем тени из области проекции в качестве веса $w(y)$, который управляет балансом двух объектов, который определяется как нормализованное среднее расстояние между $y$ и $t$ ближайшими пикселями на гранях тени из области проекции. На основе чего вычисляется вероятность пребывания точки $y$ в тени \cite{wei2019simulating}:

\begin{equation}
	\begin{cases}
		\begin{aligned}
			p(y) &= (1 - w(y)(1 - S(y)) + w(y)M(y), &&\\
			S(y) &= \frac{r(y)}{(r_s + r(y))}, &&\\
			M(y) &= \frac{|T(p) - T(q)|}{\text{max}(T(p), T(q))}, &&\\
			T(y) &= \frac{H(y)}{V(y) + 0.01}, &&\\
		\end{aligned}
	\end{cases}
\end{equation}

где $p(y)$ -- вероятность пребывания точки $y$ в тени, $S(y)$ -- отношение сходства $r(y)$ и $r_s$, $T(y)$ -- отношение оттенка $H(y)$ и значения $V(y)$ точки $y$ в пространстве HSV \cite{cheng2001color}, $M(y)$ -- разница соотношений $T(p)$ и $T(q)$.

\paragraph*{Объединение граней тени} 
""\newline\indent
Перед объединением граней теней новой области и области проекции вершины граней области проекции сортируются по глубине. Затем порядок граничных пикселей используется для соединения вершин. Чтобы избежать чрезмерных соединений, используется согласованность в направлениях градиента для уточнения связанных ребер \cite{wei2019simulating}.

Далее выбираются множества соседних вершин $N_j(x)$, где $j$ -- порядковый номер вершины. Далее выбирается набор кандидатов $C_j(x)$, где $C_j(x_i)$ -- набор пикселей граней тени в новой области в окрестности $N_j(x)$. Для каждого пикселя $x$ в окрестности $N_j(x)$ вычисляется среднее направление градиента $g_x$ по $N_j(x)$. Затем для каждого пикселя $x_i$ в $C_j(x_i)$ вычисляется направление градиента $g_{x_i}$. Угловая разница выражается так:

\begin{equation}
	d(x_i) = \frac{(g_x - g_{x_i}) ^ 2}{g_{x_i} ^ 2}.
\end{equation}

Если $d(x_i) < \alpha$ ($\alpha$ - некоторое пороговое значение), $x_i$ идентифицируется как край тени.

\subsubsection*{Построение теневого объема}

\paragraph*{Приближенное построение}
""\newline\indent
Для построения приближенного теневого объема помимо граней тени используется также информация о направлении падения солнечного света, полученная на основе местоположения пользователя и времени суток при съемке. Для каждого пикселя на краю тени испускается луч вдоль направления солнечного света, длина луча на практике равна максимально возможной величине. Если закрывающий солнце объект виден не полностью, отбрасываемая тень обычно обрезается по крайней мере на одну границу изображения. Соответственно,  теневой объем объекта будет естественным образом усечен трехмерными плоскими поверхностями границ изображения. Для полностью видимого объекта, отбрасывающего тень, используется информация о его геометрии для усечения объема тени. Благодаря такому подходу поверхность теневого объема грубо аппроксимируется серией параллелограммов \cite{wei2019simulating}.

\paragraph*{Уточненное построение} 
""\newline\indent
Для более гладкого затенения трехмерных объектов точки тени заменяются на непрерывные кривые. Делается это с помощью кривых Безье. Из-за сложной конфигурации наружных теней прямая подгонка Безье приводит к большим ошибкам. Вместо этого края тени разделяются на кусочно-гладкие сегменты с использованием дискретной кривизны. Затем множества точек границ тени делятся на сегменты. Для каждого сегмента первая точка, а именно $P_0$, и последняя точка, а именно $P_2$, устанавливаются в качестве контрольных точек. Затем, используя координаты других точек на отрезке, оптимальная точка, а именно $P_1$, получается с помощью подгонки кривой Безье методом наименьших квадратов \cite{wei2019simulating}:

\begin{equation}
	B(t) = \sum_{k=0}^{2} p_k B_{k, 1} (t) = (1 - t) ^ 2 P_0 + 2t(1 - t)P_1 + t^2 P_2.
\end{equation}

При повторной выборке подогнанных кривых количество выбранных точек должно быть достаточным для создания плавных краев тени и как можно меньшим для поддержания эффективности. Для достижения этой цели используется адаптивная стратегия выборки. Для каждого двухмерного сегмента $l$, обладающего $n$ пикселями, обозначается расстояние между первой и последней точкой сегмента $P_{2D}^1$ и $P_{2D}^n$ соответственно в виде $d(P_{2D}^1, P_{2D}^n)$, и их трехмерное расстояние $d(P_{3D}^1, P_{3D}^n)$. Их соотношение $\frac{d(P_{2D}^1, P_{2D}^n)}{d(P_{3D}^1, P_{3D}^n)}$ представляет трехмерное расстояние, соответствующее единице пикселя на изображении. Чем меньше соотношение, тем больше точек следует отобрать. Далее, когда края тени находятся далеко от камеры, количество точек выборки следует уменьшить. В противном случае следует его увеличить. Наконец, трехмерное расстояние также определяет количество точек выборки \cite{wei2019simulating}.

Конечное количество точек выборки, которое обозначается как $m$, выражается как:

\begin{equation}
	m = \text{max}(\frac{d(P_{2D}^1, P_{2D}^n)}{d(P_{3D}^1, P_{3D}^n)} \cdot \frac{d(P_{3D}^1, P_{3D}^n)}{\frac{1}{n} \sum_{i=1}^{n} d_i}, \epsilon),
\end{equation}

где $d_i$ - глубина i-й точки и $\epsilon$ - минимальное количество точек выборки, которое экспериментально установлено равным $2n$ \cite{wei2019simulating}.

Схема метода изображена на рисунке \ref{img:ShadowVolumes.drawio}.

\includeimage
{ShadowVolumes.drawio}
{f}
{H}
{0.575\textwidth}
{Схема метода на основе построения теневых объемов}

\subsubsection*{Преимущества и недостатки}

Преимущества:
\begin{itemize}
	\item[---] моделирует систему освещения вне помещения;
	\item[---] моделирует взаимодействие между тенями реальных и виртуальных объектов.
\end{itemize}

Недостатки:
\begin{itemize}
	\item[---] не позволяет моделировать освещение в помещениях;
	\item[---] работает только со статическими тенями: динамические тени не распознаются, поскольку новые грани тени добавляются к граням предыдущего кадра путем обеспечения согласованности направления градиента края;
	\item[---] плохо работает с мягкими тенями.
\end{itemize}

\subsection{Метод с использованием сверточных нейронных сетей и трассировки теневых лучей}

Суть метода -- определить координаты ИС по теням, отбрасываемым объектами. Он основан на предположении, что для небольших ИС тень объекта является изображением центральной проекции этого объекта на поверхности <<пола>>. Следовательно, зная координаты сопряженных точек границ теней и границ объектов, отбрасывающих эти тени, можно восстановить центральную проекцию и найти положение источника света \cite{sns_tras}.

Однако найти сопряженные точки -- задача нетривиальная, особенно для сложных сцен, когда есть много теней от разных ИС, и когда тени не проецируются на плоскую поверхность. Метод основан на формировании пучков лучей, исходящих из точек на границе тени. В этом случае предполагается, что среди пучков лучей, испускаемых из тени к объекту, будет хотя бы один, идущий в направлении источника света. Эти лучи формируются из точек, полученных после определения контуров объектов и теней. В качестве контура объекта рассматривается не только его геометрический контур, но и световой контур, то есть граница света и тени на самом освещаемом объекте. Группа лучей, исходящих из разных точек тени на разные точки объекта, может сформировать каустику, которая будет находиться вблизи источника света. Центр перетяжки этой каустики в пространстве сцены соответствует положению источника света. Поэтому основная задача метода -- найти группу лучей, формирующих каустику \cite{sns_tras}.

В качестве исходных данных используется RGBD-изображение сцены, не требующее калибровки по реальным значениям яркости.

Данный метод состоит из двух этапов.
\begin{enumerate}
	\item Обучение сверточной нейронной сети для определения границ объектов и теневых областей RGBD-изображений, полученных устройством ДР.
	\item Использование алгоритмов машинного зрения для определения положения источников освещения в сцене.
\end{enumerate}

Более подробно второй этап метода выглядит так.

\begin{enumerate}
	\item Определяются все теневые области на изображении.
	\item Идентифицируются объекты, отбрасывающие тени, и определяются границы объектов, включая световые границы в областях освещаемой и теневой частей объекта. Точки этих границ формируются и сохраняются.
	\item Формируются облака точек вероятного пересечения лучей, исходящих из разных точек тени и объекта. Образуются пары несопряженных лучей, то есть лучи должны исходить из разных точек через разные точки одного объекта. Поскольку фактическое пересечение таких лучей невозможно, выполняется поиск точки на отрезке с минимальным расстоянием, соединяющим две эти прямые. Точки позади объекта или за пределами области определения сцены отбрасываются. 
	\item Точки, полученные в результате пересечения траекторий лучей, помечаются номером объекта, через который прошел луч. Эта маркировка позволяет сортировать сформированные лучи.
	\item Происходит анализ областей скоплений точек, которые принимаются за положение источников света. Для каждой области координаты ИС усредняются, и средняя точка берется за точку положения ИС.
	\item Для найденных точек проверяется правильность нахождения координат ИС. Для этого от источника света на границе тени испускаются лучи и оценивается отклонение координат соответствующих точек от ближайших точек границ объекта. Если отклонение находится в пределах допуска, то найденная точка принимается за центральную точку ИС, в противном случае источник света считается ложным и отклоняется. Кроме того, близкорасположенные ИС, найденные для различных объектов, объединяются в один ИС \cite{sns_tras}.
\end{enumerate}

\subsubsection*{Определение контуров теней и объектов}

Изображения в оттенках серого и цветные изображения могут содержать значительный шум, заключающийся в случайных вариациях яркости или цветов точек изображения. Поэтому для определения контуров объектов и теней необходимо сперва устранить шум изображения, для чего используются различные методы фильтрации и алгоритмы компьютерного зрения. Для этого используются алгоритмы Кэнни \cite{canedgedetect} для обнаружения границ изображения, затем размытие по Гауссу \cite{gaus_smooth} и операция наращивания \cite{dilation} для устранения шума на границах изображения. Чтобы оставить только контуры границ, используется алгоритм скелетизации \cite{skeleton}, который уменьшает бинарные объекты до ширины одной точки изображения. 

После определения всех контуров объектов и теней на изображении необходимо найти соответствие между ними. В первую очередь строятся регионы интересов \cite{roi} области контуров, и если они соприкасаются, то есть имеют общие границы, то с большой вероятностью контур тени соответствует контуру объекта \cite{sns_tras}.

Кроме того, используется еще один метод сопоставления контуров, заключающийся в использовании функции, вычисляющей и сравнивающей по заданным регионам интересов <<моменты>> контуров изображений объектов и теней сцены. Далее в функцию сравнения контуров подаются полученные значения и возвращается метрика, показывающая сходство. Чем ниже результат на выходе функции (чем ближе она к нулю), тем больше соответствие и тем вероятнее, что сравниваемые контуры тени и объекта имеют одно происхождение, то есть тень была сформирована данным объектом \cite{sns_tras}.

\subsubsection*{Формирование лучей}

После того, как были определены все необходимые координаты на исходном изображении контуров объектов и их теней, начинается процесс формирования лучей. Они формируются с заданным шагом по контуру, например, исходя из соображения, что на контуре изображения и тени не должно быть больше 10 или 20 точек \cite{sns_tras}. Исходя из этого на контурах выбираются точки с соответствующим шагом, через которые затем выпускаются лучи, и вычисляются точки, находящиеся на минимальном расстоянии между этими лучами, то есть точки перетяжки лучей. Вычисление точек перетяжки основывается на методе наименьших квадратов, что является стандартным подходом в регрессионном анализе для аппроксимации решения переопределенных систем путем минимизации суммы квадратов, полученных в результатах каждого отдельного уравнения \cite{mnk}.

Далее определяется максимальная плотность точек перетяжки. По найденным точкам в области наибольшей плотности вычисляются моменты и находится средняя точка.

Необходимо отметить, что если в процессе поиска координат источников света использовались два или более объектов сцены, то найденные облака точек, имеющие максимальную плотность и характеризующие источники света от разных групп объектов – теней, можно объединять в один общий источник света, имеющий конечный размер. Это объединение можно делать только в том случае, если облака точек были порождены различными объектами, поскольку один объект, формирующий разные тени, не может создать один источник \cite{sns_tras}.

\subsubsection*{Преимущества и недостатки}

Преимуществами данного метода являются:

\begin{itemize}
	\item[---] моделирует систему освещения внутри помещения;
	\item[---] возможность распознать сложные тени и несколько ИС.
\end{itemize}

Недостатками данного метода являются:

\begin{itemize}
	\item[---] высокие требования к производительности системы \cite{tras}.
\end{itemize}

\section{Сравнение методов}

В качетсве критериев сравнения методов были предложены следующие:

\begin{itemize}
	\item[---] восстановление нескольких ИС;
	\item[---] работа метода в помещении;
	\item[---] работа метода вне помещения;
	\item[---] динамическая смена окружения;
	\item[---] отсутствие пересчета положения ИС.
\end{itemize}

Динамическая смена окружения подразумевает, что метод способен восстановить систему освещения при смене окружения во время своей работы (переход в другое помещение и т. п.). Пересчет положения ИС подразумевает, что метод вычисляет положения ИС в каждом кадре во время сессии, даже если система освещения не меняется, что избыточно, как ранее было сказано.

В таблице \ref{class} приведено сравнение методов.

\begin{table}[H]
	\caption{Сравнение методов наложения теней в ДР}
	\label{class}
	\begin{center}
		\begin{tabular}{| p{4 cm} | p{2 cm} | p{2 cm} | p{2 cm} | p{2 cm} | p{2 cm} |} 
			\hline
			& Восстано- вление нескольких ИС & Работа метода в помещении & Работа метода вне помещения & Динамич- еская смена окружения & Отсутст- вие пересчета положения ИС \\
			\hline
			Метод на основе анализа контуров теней ИС & + & + & - & + & - \\
			\hline
			Метод на основе построения теневых объемов & - & - & + & + & - \\
			\hline
			Метод с использованием сверточных нейронных сетей и трассировки теневых лучей & + & + & - & + & - \\
			\hline
		\end{tabular}
	\end{center}
\end{table}

Из результатов сравнения видно, что вышеописанные методы подходят для разных случаев наложения теней в дополненной реальности, но ни один из них не соответствует последнему критерию, из чего следует необходимость разрабоки собственного метода наложения теней в дополненной реальности, который ему соответствует, и для тех условий, когда схема осещения окружения в основном не изменяется.

\section{Формализация задачи}

На рисунке \ref{img:01_A0} представлена формализация задачи в виде IDEF0-диаграммы.

\includeimage
{01_A0}
{f}
{H}
{\textwidth}
{Формализация задачи в виде IDEF0-диаграммы}

\section*{Вывод}

В данном разделе были изучены предметная область, описаны основные определения ДР, компьютерного зрения и наложения теней, проведен обзор существующих методов получения данных о глубине окружения и способов построения теней на основе информации о глубине точек кадра. Также было проведено сравнение методов между собой и была формализованна задача в виде IDEF0-диаграммы.