\chapter{Аналитический раздел}


\section{Обзор существующих методов наложения теней в ДР}

\subsection{Метод с использованием HDR изображений}

В этом методе в качестве исходных данных используется информация о глобальном освещении окружающей среды и любых источниках света, присутствующих вокруг пользователя, из HDR-изображений \cite{hdri, rtsm}. Исходные изображения должны обладать следующими свойствами:

\begin{itemize}
	\item они должны быть всенаправленными, т.е. для каждого направления пространства имеется пиксель, представляющий это направление;
	\item значения пикселей соответствуют количеству света, поступающего с этого направления.
\end{itemize}

Метод состоит из 4 основных этапов:

\begin{enumerate}
	\item захват изображения;
	\item обработка изображения;
	\item поиск положения источников света;
	\item отрисовка теней.
\end{enumerate}

\subsubsection*{Захват изображения}

На основе исходных снимков создается т. н. карта сферы, которая представляет собой сферическое изображение на 360 градусов окружения, где будут размещены синтетические объекты. Чтобы удовлетворить свойство всенаправленности, наиболее часто используемым методом является фотографирование зеркальной сферы: этот метод позволяет получать свет, исходящий из-за сферы, поскольку лучи за сферой отклоняются и захватываются камерой спереди. Более простой метод состоит в том, чтобы сделать несколько фотографий всего окружения и скомпоновать их вместе, накладывая друг на друга, чтобы сформировать карту сферы \cite{rtsm}.

\subsubsection*{Обработка изображения}

Полученную карту сферы конвертируют из RGB-изображения в черно-белое для более простого применения порогового значения к
значениям цвета пикселей, поскольку они варьируются только от 0 до 255. Стоит отметить, что не все RGB-изображения после конвертировании в черно-белый формат имеют пиксели, которые варьируются от 0 до 255, например, слишком яркие или слишком темные.

После преобразования изображения можно применить для него пороговое значение, чтобы удалить все пиксели со значением цвета ниже заданного порога. Этот порог выбирается путем анализа гистограммы изображения \cite{img_hists}.

Далее проверяется следующее условие:

\begin{equation}
	\frac{Max(PixelValue)}{Average(PixelValue)} \geq 1.5
\end{equation}

Если это условие верно, то это означает, что разница между максимальным значением и средним значением пикселей достаточно, чтобы утверждать, что существует видимая разница между окружающим светом и возможным точечным светом. В ином случае возможно ошибочное отождествление окружающего света с точечным светом, что приводит, во-первых, к слишком высокой плотности белых пикселей и, во-вторых, к неточному расположению света на этапе поиска положения источников света \cite{rtsm}.

Далее происходит оценка порогового значения. Если 93\% спектра (начиная с 0) покрывают не менее 98\% пикселей, то можно пороговать оставшиеся 7\%. Этот шаг позволяет обрезать изображение и рассматривать только те области изображения, которые соответствуют реальным источникам света. Полученный результат обрабатывается медианным фильтром размытия в качестве метода шумоподавления, поскольку возможно наличие некоторых областей со значением пикселей выше порогового значения из-за отражений объектов в окружающей среде \cite{rtsm}.

\subsubsection*{Поиск положения источников света}

У полученного изображения вычисляются контуры источников света. Из полученных контуров определяются его моменты, из которых можно получить центроиды каждого источника света.

Из координат центроида $(x, y)$ можно получить координату $z$ следующим образом. Координата $x$ пропорциональна повороту вокруг оси $Y$, а координата $y$ пропорциональна повороту вокруг оси $X$, из чего следуют соотношения \cite{rtsm}:

\begin{equation}
	\begin{split}
		\frac{x}{\theta} = \frac{width}{2\pi} \\
		\frac{y}{\phi} = \frac{height}{\pi},
	\end{split}
\end{equation}

где $\theta, \phi$ -- углы поворота вокруг осей $Y$ и $X$ соответственно, $width, height$ -- ширина и высота исходного изображения окружения. Зная углы поворота вокруг осей, можно вычислить модуль координаты $z$ следующим образом:

\begin{equation}
	\begin{split}
		z_{xz} = x\cos(\theta) \\
		z_{yz} = y\cos(\phi), \\
		|z| = \sqrt{z_{xz} ^ 2 + z_{yz} ^ 2} \\
	\end{split}
\end{equation}

где $z_{xz}$ -- координата $z$ проекции точки положения виртуального ИС на плоскость $XZ$, $z_{yz}$ -- координата $z$ проекции точки положения виртуального ИС на плоскость $YZ$. Знак координаты $z$ можно восстановить следующим образом:

\begin{equation}
	\begin{split}
		\left[
		\begin{gathered}
			z = -|z|, z_{xz} < 0 \vee z_{yz} < 0 \vee z_{xz} < 0 \wedge z_{yz} < 0 \\
			z = |z|, z_{xz} \geq 0 \vee z_{yz} \geq 0
		\end{gathered}
		\right.
	\end{split}
\end{equation}

Таким образом, становится известно положение ИС в трехмерном пространстве.

\subsubsection*{Отрисовка теней}

Этот этап ничем особым не отличается по сравнению с остальными: отрисовка теней происходит по тем же алгоритмам, что и в машинной графике. Зная местоположение каждого ИС, расставляются их виртуальные аналоги. В итоге происходит синтез и отображение виртуальной сцены с виртуальным объектом, отбрасывающий тень от <<реальных>> ИС.

\subsubsection*{Преимущества и недостатки}

Преимуществами данного метода являются: 
\begin{itemize}
	\item для наложения тени на виртуальный объект требуется только вычислить тень, падающую от него, т. к. все шаги с рассчетом положения ИС уже были проделаны;
	\item возможность распознавания нескольких ИС.
\end{itemize}

Недостатками данного метода являются:
\begin{itemize}
	\item требуется предварительная подготовка информация об окружении, т. е. динамическая смена окружения не предусмотрена;
	\item корректная отрисовка теней происходит только на плоской поверхности, т. е. нельзя воспроизвести её искажение, т. к. нет информации о поверхности проецирования.
\end{itemize}

\subsection{Метод на основе анализа контура теней ИС}

В качестве исходных данных используются RGBD-изображения.

Для того чтобы определить положение источников света, предлагаемый алгоритм должен обладать двумя основными наборами данных. Во-первых, точки на RGBD-изображении, соответствующие границам объектов, и, во-вторых, точки на RGBD изображении, соответствующие границам теней от объектов. Хотя эти данные представляют собой два несвязанных набора точек, однако алгоритм предполагает, что имеется прямое соответствие между объектами и их тенями на RGBD-изображении \cite{shadow_contours_method}.

Полученные наборы точек используются алгоритмом нахождения положений источников света, поскольку пересечение лучей, сформированных сопряженными точками, находящимися на границах тени и объекта, даст точку, соответствующую положению источника света, сформировавшему эту тень от объекта. Поэтому алгоритм состоит из двух основных функций: нахождение сопряженных точек и определение точки пересечения лучей, сформированных сопряженными точками. Для реализации этих функций формируется набор виртуальных плоскостей с регулярной пространственной сеткой. Плоскости располагаются параллельно поверхности земли, которая формируется из анализа RGBD изображения. Лучи, сформированные точками от границ тени на точки границ объектов, пересекают виртуальные плоскости и оставляют на них следы (точки). Положения источников света находятся итерационно на основе результатов анализа распределения точек на регулярной сетке. Метод поэтапно проверяет все возможные плоскости, на которых может находиться источник света. Регулярная сетка позволяет найти все скопления точек среди всего множества точек, пересекших виртуальную плоскость. Все скопления точек запоминаются для следующих итераций. На дальнейших итерациях проверяется характер распределения этих скоплений. Скопление точек, полученное данным методом, уплотняется при приближении к виртуальной плоскости к источнику света. На определенном шаге итераций скопление точек перестанет уплотняться и в дальнейшем будет расширяться. Максимальная плотность скопления свидетельствует о том, что источник света находится на высоте виртуальной плоскости. Одним из ограничений данного метода является невозможность восстановить интенсивность и диаграмму излучения источника света. Поэтому для освещения виртуального объекта модель использует Ламбертову диаграмму излучения с интенсивностью, соответствующей яркости объекта, отбрасывающего тень.

После того как виртуальная плоскость найдена, появляется одна координата положения источника света. Центр скопления точек на виртуальной плоскости позволяет определить две оставшиеся координаты. При этом абсолютная ошибка определения координаты источника света по высоте не превышает половины шага, с которым чередуются виртуальные плоскости. Если ошибка определения координат источника света окажется значительной, то на следующих кадрах, формируемых видеосистемой смешанной реальности, можно скорректировать положение источника света на основе новых данных. Этими данными могут быть параметры RGBD-изображения сцены, найденные устройством смешанной реальности, например, более четкие границы теней и объектов сцены. Используя вычисленные положения источников света, система смешанной реальности формирует корректное освещение виртуальных объектов сцены.

Алгоритм данного метода состоит из следующих шагов.
\begin{enumerate}
	\item Получение входных данных от устройства ДР: RGBD-изображение сцены.
	\item Поиск и распознавание объектов и теней этих объектов по RGBD-изображению сцены.
	\item Формирование наборов точек на границах объектов и их теней. Контуры объектов и контуры теней дают два несвязанных набора точек. Количество найденных точек практически не сказывается на точности, но найденные точки должны быть расположены равномерно по контуру изображения объекта и отклонение точек от границы контура не должно быть значительным. Количество точек на контурах объектов и их теней не должно быть меньше 3.
	\item Построение лучей, направленных из каждой точки контура тени объекта на каждую точку контура соответствующего объекта, и поиск точек пересечения полученных лучей с виртуальными плоскостями <<потолка>>, расположенными параллельно горизонту. В результате на виртуальных плоскостях формируются облака точек. Высокая плотность распределения группы точек говорит о близости положения виртуальной плоскости к источнику света.
	\item Формирование распределения точек на регулярной сетке виртуальной плоскости. Поскольку проверка взаимного расположения точек на плоскости является затратной операцией, то для более быстрой обработки точек используется двумерная регулярная сетка с фиксированным размером ячеек. Сетка заполняется точками, полученными на предыдущем шаге.
	\item Поиск виртуальных поверхностей с максимально плотным распределением групп точек. Максимальное количество точек в ячейке регулярной сетки свидетельствует о том, что данные точки с большой вероятностью были сформированы лучами, идущими от границы тени на объект в направлении источника света. Следовательно, максимальная плотность найденных точек будет свидетельствовать о том, что в этой области находится источник света. Если ни для одной виртуальной плоскости не удается достичь высокой плотности точек, то источник света не найден. Это может происходить, например, если объекты и их тени были некорректно согласованы или видимый край объекта не является краем, создающим тень. Если была найдена группа точек с высокой плотностью, геометрический центр этих точек формирует положение источника света. Тип найденного источника света устанавливается точечным, а диаграмма излучения -- Ламбертовой.
	\item Уточнение координат источников света с использованием билинейной интерполяции между двумя виртуальными плоскостями с максимальной плотностью точек. На следующих RGBD кадрах, формируемых видеосистемой смешанной реальности, можно скорректировать положение источника света на основе новых данных.
	\item Синтез виртуальных объектов при найденных источниках освещения.
	\item Вывод синтезированного изображения.
\end{enumerate}


\subsubsection*{Преимущества и недостатки}

Одним из ограничений данного метода является невозможность восстановить интенсивность и диаграмму излучения источника света

Недостатком данного метода является зависимость качества его работы от результатов распознавания контуров объектов и теней. Устройство распознавания может распознать только часть контуров, например, распознанная часть тени может не соответствовать обнаруженному контуру объекта. 

\subsection{Метод с использованием RGBD-данных}



\subsection{Метод с использованием сверточных нейронных сетей и трассировки теневых лучей}

Суть метода -- определить координаты ИС по теням, отбрасываемые объектами. Он основан на предположении, что для небольших ИС тень объекта является изображением центральной проекции этого объекта на поверхность <<пола>>. Следовательно, зная сопряженные координаты точек границ теней и координаты точек границ объектов, отбрасывающих эти тени, можно восстановить центральную проекцию и найти положение источника света \cite{sns_tras}.

Однако найти точки сопряжения -- задача нетривиальная, особенно для сложных сцен, когда есть много теней от разных ИС и когда тени не проецируются на плоскую поверхность. Метод основан на формировании пучков лучей, исходящих из точек на границе тени. В этом случае предполагается, что среди пучков лучей, испускаемых из тени к объекту, будет хотя бы один, идущий в направлении источника света. Эти лучи формируются из точек, полученных после определения контуров объектов и теней. В качестве контура объекта рассматривается не только его геометрический контур, но и световой контур, т. е. граница света и тени на самом освещаемом объекте. Группа лучей, исходящих из разных точек тени на разные точки объекта, может сформировать каустику, которая будет находиться вблизи источника света. Центр перетяжки этой каустики в пространстве сцены соответствует положению источника света. Поэтому основная задача метода -- найти группу лучей, формирующих каустику \cite{sns_tras}.

В качестве исходных данных используется изображение в формате RGBD, не требующее калибровки по реальным значениям яркости.

Данный метод состоит из двух этапов.
\begin{enumerate}
	\item Обучение сверточной нейронной сети для определения границ объектов и теневых областей RGBD-изображений, полученных устройством ДР.
	\item Использование алгоритмов машинного зрения для определения положения источников освещения в сцене.
\end{enumerate}

Более подробно метод выглядит так.

\begin{enumerate}
	\item Получение входных данных от MR-устройства, а именно изображения в RGBD формате, содержащего карты глубины сцены.
	\item Формирование облака точек из RGBD изображения. Для
	формирования используется информация о состоянии и ориентации устройства ДР.
	\item Анализ изображения. Использование обученной сверточной нейронной сети для определения всех теневых областей на изображении.
	\item Идентификация объектов, отбрасывающих тени, и выделение их разными цветами на изображении. Нахождение границ объектов, включая световые границы в области освещаемой и теневой части объекта.
	\item Формирование и сохранение координат точек видимых и световых границ объектов и теней. 
	\item Формирование облака точек вероятного пересечения лучей, исходящих из разных точек тени и объекта. Образуются пары несопряженных лучей, т. е. лучи должны исходить из разных точек через разные точки одного объекта. Поскольку фактическое пересечение таких лучей невозможно, выполняется поиск точки на отрезке с минимальным расстоянием, соединяющим две эти прямые. Точки позади объекта или за пределами области определения сцены отбрасываются. 
	\item Точки, полученные в результате пересечения траекторий лучей, помечаются номером объекта, через который прошел луч. Эта маркировка позволяет сортировать сформированные лучи.
	\item В области сцены формируется пространственная структура для определения плотности точек пересечения лучей. Структура имеет многоуровневую организацию, где каждый уровень представляет собой обычную трехмерную регулярную решетку, расположенную в родительской ячейке.
	\item Анализ областей концентрации точек, которые принимаются за положение источников света. Для каждой области координаты источника света усредняются, и средняя точка берется за точку положения источника света.
	\item Для найденных точек проверяется правильность нахождения координат источника света. Для этого от источника света на границе тени испускаются лучи и оценивается отклонение координат соответствующих точек от ближайших точек границ объекта. Если отклонение находится в пределах допуска, то найденная точка принимается за центральную точку источника света, в противном случае источник света считается ложным и отклоняется. Кроме того, близкорасположенные источники света, найденные для различных объектов, объединяются в один источник света.
\end{enumerate}

\subsubsection*{Определение контуров теней и объектов}

Изображения в оттенках серого и цветные изображения могут содержать значительный шум, заключающийся в случайных вариациях яркости или цветов точек изображения. Поэтому для определения контуров объектов и теней необходимо сперва устранить шум изображения, для чего используются различные методы фильтрации и алгоритмы компьютерного зрения. Для этого используются алгоритмы Кэнни \cite{canedgedetect} для обнаружения границ изображения, затем размытие по Гауссу \cite{gaus_smooth} и операция наращивания \cite{dilation} для устранения шума на границах изображения. Чтобы оставить только контуры границ, используется алгоритм скелетизации \cite{skeleton}, который уменьшает бинарные объекты до ширины одной точки изображения. 

После определения всех контуров объектов и теней на изображении необходимо найти соответствие между ними. В первую очередь строятся регионы интересов \cite{roi} области контуров, и если они соприкасаются, т. е. имеют общие границы, то с большой вероятностью контур тени соответствует контуру объекта \cite{sns_tras}.

Кроме того, используется еще один метод сопоставления контуров, заключающийся в использовании функции, вычисляющей и сравнивающей по заданным регионам интересов «моменты» контуров изображений объектов и теней сцены. Моменты изображения представляют собой средневзвешенное значение интенсивности пикселей изображения, т. е. это суммарная характеристика контура, рассчитанная интегрированием (суммированием) всех пикселей контура. Все что необходимо -- это вычислить сумму интенсивностей всех пикселей и получить на выходе значение. Далее в функцию сравнения контуров подаются полученные значения и возвращается метрика, показывающая сходство. Чем ниже результат на выходе функции (чем ближе она к нулю), тем больше соответствие и тем вероятнее, что сравниваемые контуры тени и объекта имеют одно происхождение, т. е. тень была сформирована данным объектом.

\subsubsection*{Формирование лучей}

После того, как были определены все необходимые координаты на исходном изображении контуров объектов и их теней, начинается процесс формирования лучей. Они формируются с заданным шагом по контуру, например, исходя из соображения, что на контуре изображения и тени не должно быть больше 10 или 20 точек \cite{sns_tras}. Исходя из этого на контурах выбираются точки с соответствующим шагом, через которые затем выпускаются лучи, и вычисляются точки, находящиеся на минимальном расстоянии между этими лучами, т. е. точки перетяжки лучей. Вычисление точек перетяжки основывается на методе наименьших квадратов, что является стандартным подходом в регрессионном анализе для аппроксимации решения переопределенных систем путем минимизации суммы квадратов, полученных в результатах каждого отдельного уравнения \cite{mnk}.

Далее определяется максимальная плотность точек перетяжки. По найденным точкам в области наибольшей плотности вычисляются моменты и находится средняя точка.

Необходимо отметить, что если в процессе поиска координат источников света использовались два или более объектов сцены, то найденные облака точек, имеющие максимальную плотность и характеризующие источники света от разных групп объектов – теней, можно объединять в один общий источник света, имеющий конечный размер. Это объединение можно делать только в том случае, если облака точек были порождены различными объектами, поскольку один объект, формирующий разные тени, не может создать один источник \cite{sns_tras}.

\subsubsection*{Преимущества и недостатки}



\section{Анализ предметной области}



\section{Критерии сравнения}



\section{Классификация существующих методов}


