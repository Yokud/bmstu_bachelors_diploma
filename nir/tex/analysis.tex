\chapter{Анализ предметной области}

\section{Предметная область}

\textbf{Предметная область} -- наложение теней  на виртуальные объекты в ДР на основе информации о реальном окружении.

\textbf{Объект исследования} -- методы наложения теней  на виртуальные объекты в ДР.

\textbf{Предмет исследования} -- способы восстановления модели освещения окружения.

\section{Актуальность задачи}

Рендеринг синтетических объектов в реальных сценах является важным применением компьютерной графики, особенно в области архитектуры и визуальных эффектов. Часто предмет обстановки, реквизит, цифровое существо или актер должны быть плавно перенесены в реальную сцену. Эта сложная задача требует, чтобы объекты освещались последовательно с поверхностями, находящимися поблизости от них, и чтобы взаимодействие света между объектами и их окружением было должным образом смоделировано. В частности, объекты должны отбрасывать тени, появляться в отражениях и преломлять, фокусировать и излучать свет точно так же, как это делали бы реальные объекты \cite{debevec2008rendering}.

Проблема визуализации виртуальных объектов в реальном мире -- низкое качество конечного изображения, из-за чего у пользователя не создается ощущение погружения в происходящее. Проблему низкого качества изображения можно разделить на две части: проблема материала и проблема освещения. Однако даже с использованием ультрареалистичных материалов для виртуальных объектов наблюдение за ними без использования системы освещения и отбрасывания теней не способствует реалистичности сцены \cite{osti2019real}.

Таким образом, использование системы освещения, в частности, наложение теней на виртуальные объекты в ДР имеет важное значение для высокого качества конечного изображения, поскольку это уменьшает дискомфорт от восприятия виртуальных объектов в реальном окружении и увеличивает уровень ощущения погружения в происходящее.

\section{Основные определения}

\subsection{Дополненная реальность и компьютерное зрение}

\textit{ДР} -- технология интеграции цифровой информации в виде изображений, компьютерной графики, текста, видео, аудио и т.д. и объектов действительного (физического) мира в режиме реального времени \cite{tech-ar}.

\textit{Компьютерное зрение} -- теория и технология создания машин, которые могут производить обнаружение, слежение и классификацию объектов \cite{comp_vision}. 

Компьютерное зрение визуализирует трехмерные виртуальные объекты с той же точки зрения, с которой изображения реальной сцены снимаются камерами слежения. Регистрация изображений в дополненной реальности использует другой метод компьютерного зрения, в основном связанный с отслеживанием видео. Эти методы обычно состоят из двух этапов: отслеживания и реконструкции/распознавания. Во-первых, на изображениях камеры обнаруживаются опорные маркеры, оптические изображения или точки интереса. Отслеживание может использовать обнаружение объектов, обнаружение краев или другие методы обработки изображений для интерпретации изображений с камеры. В компьютерном зрении большинство доступных методов отслеживания можно разделить на два класса: основанные на объектах и основанные на моделях. Методы, основанные на объектах, состоят в обнаружении связи между элементами двухмерного изображения и их координатами трехмерной сцены. Методы, основанные на моделях, используют модели характеристик отслеживаемых объектов, такие как модели САПР \cite{cad} или двухмерные шаблоны элемента, основанные на различимых признаках. Как только установлено соединение между двухмерным изображением и трехмерной сценой, можно определить положение камеры, проецируя трехмерные координаты объекта в наблюдаемые двухмерные координаты изображения и минимизируя расстояние до соответствующих двухмерных объектов. Ограничения для оценки положения камеры чаще всего определяются с использованием точечных объектов. Этап восстановления/распознавания использует данные, полученные на первом этапе, для восстановления системы координат реального мира \cite{ar_overview}.

\subsection{Данные об окружении}

При решении данной задачи в качестве исходных данных используются HRD-изображения или RGBD-изображения.

\textit{HDR} -- общее название технологий работы с изображениями, диапазон яркости которых превышает возможности стандартных технологий. \textit{Динамический диапазон} -- отношение между максимальным и минимальным значением физической величины: для фотографии это отношение между самой яркой и самой темной частями изображения. Фотографической широты современных камер и пленок недостаточно для того, чтобы передать любой сюжет окружающего мира. Эта проблема решается путем увеличения динамического диапазона самих камер или комбинирования изображений, снятых с разной экспозицией, в результате которого возникает единое изображение, содержащее все детали из всех исходных изображений, как в крайних тенях, так и в максимальных светах. \textit{HDR-изображение} -- изображение с расширенным динамическим диапазоном. Информация о цвете каждого пикселя HDR-изображения хранится в виде числа с плавающей точкой, в отличие от цветовой модели RGB, где используется 3 байта для трех основных цветов: красный, зеленый, синий \cite{hdri}.

\textit{RGBD-изображение} -- изображение, в котором каждый его пиксель помимо информации о цвете хранит информацию и о глубине \cite{rgbd}. Существует несколько способов получения информации о глубине точек кадра:

\begin{itemize}
	\item структурированный свет;
	\item Time-of-Flight;
	\item лидар (также LIDAR или LiDAR);
\end{itemize}

\subsubsection*{Структурированный свет}

Данный способ полагается на проектор света, захваченный камерой. Самый простой способ достичь такой цели -- спроецировать точку с помощью устройства и запечатлеть эту точку в сцене с помощью камеры. Глубина этой точки может быть измерена с помощью триангуляции. Для оценки глубины необходимо найти положение проецируемой точки в плоскости изображения, иметь расстояние между камерой и световым проектором, внутренние параметры камеры и положение проектора в пространстве. Используя эту информацию, можно создать треугольник и рассчитать высоту треугольника, образованного камерой, проектором и освещенной точкой сцены, чтобы определить расстояние. Большинство датчиков структурированного света не работают под прямыми лучами солнца, поскольку они полагаются на проекцию света в сцене. Поэтому они обычно подходят для использования в помещениях \cite{rgbd}.

\subsubsection*{Time-of-Flight}

Данный способ основан на оценке расстояния объекта в сцене до датчика путем измерения времени, необходимого для приема датчиком излучаемого света. Поэтому датчики полагаются на время, которое требуется световой волне, чтобы дойти до точки сцены и отразиться от датчика. Концепция практически не отличается от ультразвуковых и радарных датчиков, но здесь в качестве излучаемого сигнала используется свет. При сильном солнечном свете датчик может давать сбои, поэтому данный способ также чаще всего используют в помещениях \cite{rgbd}.

\subsubsection*{Лидар}

Данный способ использует ту же идею измерения времени, в течение которого излучаемый свет принимается датчиком, но они полагаются на один или несколько лазерных лучей (концентрированный свет) для измерения глубины точек в сцене. Лидарный датчик полагается на сфокусированные лазерные лучи, которые позволяют проводить измерения расстояния до нескольких километров. Точность измерений обычно не зависит от расстояния, хотя может зависеть от погодных условий: при неблагоприятных условия, например, густой туман и бурный снегопад, она может падать. Лидарные датчики излучают свет, поэтому они работают в сложных условиях освещения, таких как темная среда. Они подходят для использования в помещениях и на открытом воздухе \cite{rgbd}.

\subsection{Модели освещения}

% Тупо написать про освещение и системы освещения из компьютерной графики и про тени чото взять из роджерса

\textit{Свет} -- электромагнитная энергия, воспринимаемая человеческим глазом \cite{big_rus_enc}.

Интенсивность света рассчитывается по Закону Ламберта:

\begin{equation}
	I = I_l k_d \cos \theta,
\end{equation}

где $I$ -- интенсивность отраженного света, $I_l$ -- интенсивность ИС, $k_d$ -- коэффициент диффузного отражения ($0 \leq k_d \leq 1$), $\theta$ -- угол между направлением света и нормалью к поверхности ($0 \leq \theta \leq \frac{\pi}{2}$). Если $\theta > \frac{\pi}{2}$, то источник света расположен за объектом. Коэффициент диффузного отражения $k_d$ зависит от материала и длины волны света, но обычно считается постоянным \cite{rogers}.

ИС бывают \cite{eberly20063d}:

\begin{itemize}
	\item направленными -- предполагается, что ИС находится бесконечно далеко, так что все направления световых лучей параллельны;
	\item точечными -- ИС расположен в пространстве и излучает свет во всех направлениях;
	\item прожекторными -- ИС имеет местоположение в пространстве, но излучает свет только внутри конуса.
\end{itemize}

\textit{Модель освещения} -- алгоритм рассчета освещения сцены \cite{eberly20063d}. 

Модели освещения бывают простыми и полными. Простые модели освещения основаны на эстетической и экспериментальной аппроксимациях, в особенности зеркальная компонента отражения. Полные же удаляет внимание распределению энергии падающего света, т. е. вводят зависимость компонентов модели от физических параметров: длина волны света, свойств вещества, шероховатости поверхности, геометрии отражения и т. д. \cite{rogers}.

Среди простых моделей освещения выделяют:

\begin{itemize}
	\item плоская модель освещения -- интенсивность света вычисляется для каждой вершины грани трехмерного объекта, а затем усредняется и присваивается всей грани;
	\item модель освещения Гуро -- происходит интерполяция интенсивности света между вершинами грани;
	\item модель освещения Фонга -- происходит интерполяция нормали к поверхности между вершинами грани;
	\item модель освещения Блина-Фонга -- улучшение модели Фонга, в котором бликовая составляющая света вычисляется отдельно с помощью медианного вектора, который расположен между вектором взгляда и вектором освещенности.
\end{itemize}

Среди полных моделей освещения выделяют модель освещения Кука-Торренса. В ней интенсивность света в заданной точке зависит от следующих факторов:

\begin{itemize}
	\item шероховатость поверхности;
	\item загораживание и затенение;
	\item коэффициент Френеля.
\end{itemize}

Также модели освещения м. б. локальными, т. е. интенсивность света в заданной точке зависит только от параметров ИС и материала поверхности, и глобальными, т. е. интенсивность света в заданной точке зависит и от освещенности соседних объектов \cite{rogers}.

\subsection{Наложение теней}

Тень состоит из двух частей: полутени и полной тени. Полная тень -- центральная, темная, резко отчерченная часть, а полутень -- окружающая ее более светлая часть \cite{rogers}.

Существует несколько методов построения теней:

\begin{itemize}
	\item использование теневой карты;
	\item построение теневого объема;
	\item трассировка лучей.
\end{itemize}



\section{Сложность наложения теней в ДР}

% Проблема -- шум изображения. решение -- калибровка камеры и фильтрация
