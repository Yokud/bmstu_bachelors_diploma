\chapter{Анализ предметной области}

В данном разделе изучается предметная область, обосновывается актуальность задачи, описываются основные определения ДР, компьютерного зрения, моделей освещения и наложения теней, проводится обзор существующих методов получения данных о глубине окружения, моделей освещения и способов построения теней, а также определяются основные сложности решения задачи наложения теней в ДР.

\section{Предметная область}

\textbf{Предметная область} -- наложение теней в ДР.

\textbf{Объект исследования} -- методы наложения теней, отбрасываемых виртуальными объектами, на реальные объекты в ДР.

\textbf{Предмет исследования} -- способы восстановления модели освещения окружения для наложении теней, отбрасываемых виртуальными объектами на реальные в ДР.

\section{Актуальность задачи}

Совмещение синтезированных изображений объектов с реальными сценами является важным применением компьютерной графики, особенно в области архитектуры и визуальных эффектов. Часто предмет обстановки, реквизит, цифровое существо или актер должны быть плавно перенесены в реальную сцену. Эта сложная задача требует, чтобы взаимодействие света с объектами виртуального окружения было должным образом смоделировано. В частности, объекты должны отбрасывать тени, появляться в отражениях и преломлять, фокусировать и излучать свет точно так же, как это делали бы реальные объекты \cite{debevec2008rendering}.

Проблема визуализации виртуальных объектов в реальном мире -- низкое качество конечного изображения, из-за чего у пользователя не создается ощущение погружения в происходящее. Проблему низкого качества изображения можно разделить на две части: проблема материала и проблема освещения. Однако даже с использованием ультрареалистичных материалов для виртуальных объектов наблюдение за ними без использования системы освещения и отбрасывания теней не способствует реалистичности сцены \cite{osti2019real}.

Таким образом, использование системы освещения, в частности, наложение теней, отбрасываемых виртуальными объектами, на реальные объекты в ДР, имеет важное значение для высокого качества конечного изображения, поскольку это уменьшает дискомфорт от восприятия изображений виртуальных объектов в реальном окружении и увеличивает уровень ощущения погружения в происходящее на экране.

\section{Основные определения}

\subsection{Дополненная реальность и компьютерное зрение}

\textit{Дополненная реальность} -- технология интеграции цифровой информации в виде изображений компьютерной графики, текста, видео, и другой информации и изображений объектов действительного (физического) мира в режиме реального времени \cite{tech-ar}.

\textit{Компьютерное зрение} -- теория и технология создания машин, которые могут производить обнаружение, слежение и классификацию объектов \cite{comp_vision}. 

Технология ДР полагается на теорию компьютерного зрения, а точнее на анализ и обработку изображений. В области
ДР алгоритмы компьютерного зрения используются для поиска в видеопотоке специальных маркеров или точек интереса. Алгоритмы компьютерного зрения позволяют выделять ключевые особенности на изображении (границы области, углы), производить поиск объектов в реальном времени и многое другое. После нахождения маркеров или точек интереса в видеопотоке и вычислении их местоположения, появляется возможность построения матрицы проекции и позиционирования виртуальных моделей. С помощью матриц проекции и позиционирования можно наложить виртуальный объект на видеопоток таким образом, что будет достигнут эффект присутствия \cite{tech-ar}.

\subsection{Данные об окружении}

При наложении теней в качестве исходных данных используются HDR-изображения или RGBD-изображения \cite{debevec2008rendering} \cite{sns_tras}.

\textit{HDR} -- общее название технологий работы с изображениями, диапазон яркости которых превышает возможности стандартных технологий. \textit{Динамический диапазон} -- отношение между максимальным и минимальным значением физической величины: для фотографии это отношение между самой яркой и самой темной частями изображения. Фотографической широты современных камер и пленок не всегда достаточно для того, чтобы передать естественное освещение окружающего мира. Эта проблема решается путем увеличения динамического диапазона самих камер или комбинирования изображений, снятых с разной экспозицией, в результате чего возникает единое изображение, содержащее все детали из всех исходных изображений, как самых тусклых, так и самых ярких. \textit{HDR-изображение} -- изображение с расширенным динамическим диапазоном. Информация о цвете каждого пикселя HDR-изображения хранится в виде числа с плавающей точкой, в отличие от цветовой модели RGB, где используется 3 байта для трех основных цветов: красный, зеленый, синий \cite{hdri}.

\textit{RGBD-изображение} -- изображение, в котором каждый его пиксель помимо информации о цвете хранит информацию и о глубине \cite{rgbd}. Существует несколько способов получения информации о глубине точек кадра:

\begin{itemize}
	\item структурированный свет;
	\item стереокамера;
	\item время полета (также Time-of-Flight);
	\item лидар (также LIDAR или LiDAR);
\end{itemize}

\subsubsection*{Структурированный свет}

Данный способ полагается на проектор света, который проецирует шаблоны на реальные объекты. В качестве шаблонов могут быть точка, линия, полоса определенной толщины и регулярная сетка. Однако первые три шаблона требуют поворота проектора хотя бы по одной оси для сканирования всей области, поэтому обычно используют регулярную сетку, для которой этого не требуется \cite{struct_light}. 

Для проектора ипользуется инфракрасный свет для минимизации помех. На основе искажения шаблона можно восстановить информацию о глубине с помощью паралакса, зная положение проектора в системе координат камеры. Большинство датчиков структурированного света не работают под прямыми лучами солнца, поскольку они полагаются на проекцию света в сцене. Поэтому они обычно подходят для использования в помещениях \cite{struct_light}.

\subsubsection*{Стереокамера}

Данный способ схож со структурированным светом, но отличается использованием еще одной камеры вместо проектора. Зная положения проекций одной и той же точки на изображения камер, и расстояние между камерами, можно вычислить глубину этой точки на основе паралакса. Стереокамеры работают как в помещении, так и на открытом воздухе. Проблемы же у данного способа возникают при анализе глубины точек гладкой окрашенной стены, так как изображения на обеих камерах эквивалентны. \cite{rgbd}.

\subsubsection*{Время полета}

Данный способ основан на оценке расстояния от датчика до наблюдаемого объекта путем измерения времени, необходимого для приема датчиком излучаемого света, отраженного от объекта. Поэтому датчики используют модуляцию излучаемого светового сигнала и сравнивают изменение фазы выпущенного сигнала и отраженного. Концепция практически не отличается от ультразвуковых и радарных датчиков, но здесь в качестве излучаемого сигнала используется свет. При сильном солнечном свете датчик может давать сбои, поэтому данный способ также чаще всего используют в помещениях \cite{rgbd}.

\subsubsection*{Лидар}

Данный способ использует идею измерения времени движения света, в течение которого излучаемый свет принимается датчиком, но они полагаются на один или несколько лазерных лучей (концентрированный свет) для измерения глубины точек в сцене. Лидарный датчик полагается на сфокусированные лазерные лучи, которые позволяют проводить измерения расстояния до нескольких километров. Точность измерений обычно не зависит от расстояния, хотя может зависеть от погодных условий: при неблагоприятных условия, например, густой туман и бурный снегопад, она может падать. Лидарные датчики излучают свет, поэтому они работают в сложных условиях освещения, например, при недостатке освещения. Они подходят для использования в помещениях и на открытом воздухе \cite{rgbd}.

\subsection{Модели освещения}

\textit{Свет} -- электромагнитная энергия, воспринимаемая человеческим глазом \cite{big_rus_enc}.

Интенсивность отраженного света рассчитывается по Закону Ламберта:

\begin{equation}
	I = I_l k_d \cos \theta,
\end{equation}

где $I$ -- интенсивность отраженного света, $I_l$ -- интенсивность ИС, $k_d$ -- коэффициент диффузного отражения ($0 \leq k_d \leq 1$), $\theta$ -- угол между направлением света и нормалью к поверхности ($0 \leq \theta \leq \frac{\pi}{2}$). Если $\theta > \frac{\pi}{2}$, то источник света расположен за объектом. Коэффициент диффузного отражения $k_d$ зависит от материала и длины волны света, но обычно считается постоянным \cite{rogers}.

ИС бывают:

\begin{itemize}
	\item направленными -- предполагается, что ИС находится бесконечно далеко, так что все направления световых лучей параллельны;
	\item точечными -- ИС расположен в пространстве и излучает свет во всех направлениях;
	\item прожекторными -- ИС имеет местоположение в пространстве, но излучает свет только внутри конуса;
	\item рассеянными -- является источником общего освещения, благодаря которому вся сцена обладает одинаковой интенсивностью света.
\end{itemize}

\textit{Модель освещения} -- алгоритм рассчета освещения сцены \cite{eberly20063d}. 

Модели освещения бывают простыми и полными. Простые модели освещения основаны на эстетической и экспериментальной аппроксимациях, в особенности зеркальная компонента отражения. Полные же удаляет внимание распределению энергии падающего света, т. е. вводят зависимость компонентов модели от физических параметров: длина волны света, свойств вещества, шероховатости поверхности, геометрии отражения и т. д. \cite{rogers}.

Среди простых моделей освещения выделяют:

\begin{itemize}
	\item плоская модель освещения -- интенсивность света вычисляется для каждой вершины грани трехмерного объекта, а затем усредняется и присваивается всей грани;
	\item модель освещения Гуро -- происходит интерполяция интенсивности света между вершинами грани;
	\item модель освещения Фонга -- происходит интерполяция нормали к поверхности между вершинами грани;
	\item модель освещения Блина-Фонга -- улучшение модели Фонга, в котором бликовая составляющая света вычисляется отдельно с помощью медианного вектора, который расположен между вектором взгляда и вектором освещенности.
\end{itemize}

Среди полных моделей освещения выделяют модель освещения Кука-Торренса. В ней интенсивность света в заданной точке зависит от следующих факторов:

\begin{itemize}
	\item шероховатость поверхности;
	\item загораживание и затенение;
	\item коэффициент Френеля.
\end{itemize}

Также модели освещения могут быть локальными, в которых интенсивность света в заданной точке зависит только от параметров ИС и материала поверхности, и глобальными, в которых интенсивность света в заданной точке зависит и от освещенности соседних объектов \cite{rogers}.

\subsection{Наложение теней}

Тень состоит из двух частей: полутени и полной тени. Полная тень -- центральная, темная, резко отчерченная часть, а полутень (или мягкая тень) -- окружающая ее более светлая часть. Полная тень образуется при полном отсутствии света, а полутень освещается частью рассеянного света ИС \cite{rogers}.

Существует несколько методов построения теней:

\begin{itemize}
	\item использование теневой карты;
	\item построение теневого объема;
	\item обратная трассировка лучей.
\end{itemize}

\subsubsection*{Теневая карта}

Теневая карта -- объект, хранящий информацию о затененных пикселях буфера кадра. Основная идея использования теневой карты -- построение карты глубины с точки зрения ИС и сравнение с картой глубины виртуальной камеры: те пиксели, которые видны с точки зрения камеры, но не видны с точки зрения ИС, являются затененными. Этот процесс называется \textit{теневым тестом}. Такой подход не требователен к вычислительным ресурсам, но требователен к памяти, поскольку теневая карта обладает тем же разрешением, что и конечное изображение, и таких карт может быть несколько в зависимости от количества ИС \cite{engel2008programming}.

\subsubsection*{Теневой объем}

\textit{Теневой объем} -- это область пространства, доступ света в которую закрывает объект. Боковые границы теневого объема образуются четырехугольниками, расположенными от границ объекта, направленных на ИС, до некоторой пересекающейся с теневым объемом плоскостью. Границы ближнего к источнику основания четырехугольника образуются так называемыми границами силуэта. Эти границы образуются сторонами треугольников, находящимися на границе затененной и освещенной областей объекта или рядом с ней. В общем случае граница силуэта пролегает по границе между треугольниками, один из которых обращен к источнику света, а другой -- в обратную сторону. Чтобы получить теневой объем, нужно найти все границы силуэта и нарисовать четырехугольники для каждой из них. Границы же дальнего основания образуются границами пересечения теневого объема с ближайщей к ИС плоскостью \cite{shad_vol}.

Освещенность точки определяется следующим образом: от точки местоположения камеры до нее проводится луч, который связан со счетчиком прохождения граней теневого объема. При входе в грань теневого объема счетчик увеличивается, при выходе -- уменьшается. В итоге, если счетчик больше нуля, то точка считается затененной, иначе -- она освещена.

Такой подход может давать ложные результаты, если камера находится внутри теневого объема. Эта проблема устраняется решением обратной задачи -- трассировкой лучей из бесконечности к точке местоположения камеры \cite{shad_vol}.

\subsubsection*{Обратная трассировка лучей}

Обратная трассировка лучей -- это метод оценки освещенности, при котором для каждого пикселя в буфере кадра луч, выпущенный из пикселя, сталкивается с объектами сцены, чтобы определить отраженный цвет объекта. Луч может быть прослежен дальше, после первого столкновения с некоторым объектом, для создания эффектов, подобных зеркалу или стеклу. Тени с трассировкой лучей оцениваются аналогично оценке отражённого объектом света, но вместо оценки столкновения лучей из буфера кадра со сценой проверка столкновения выполняется для лучей от сцены к источнику света. Если луч от текущего пикселя столкнется с каким-либо объектом до того, как достигнет источника света, текущий пиксель окажется в тени, и, таким образом, его цвет будет темнее по сравнению с основным цветом его материала \cite{engel2008programming}.

\section{Основные сложности наложения теней в ДР}

Основные проблемы данной задачи -- обеспечение геометрического и светового взаимодействия виртуального и реального миров \cite{sns_tras}.

Геометрическое взаимодействие подразумевает то, что объекты виртуального мира, находящиеся за объектами реального мира, не должны быть видны \cite{sns_tras}.

Световое взаимодействие подразумевает обеспечение корректного освещения виртуальных объектов ИС реального мира (включая правильное формирование теней от виртуальных объектов, отбрасываемых на реально существующие предметы) и корректное освещение предметов реального мира виртуальными ИС (включая вторичное освещение, возникающее при переотражении света между объектами реального и виртуального миров). Появление некорректностей в модели освещения виртуальных объектов вызывает дискомфорт восприятия совмещённого изображения, на котором  смешаны объекты реального и виртуального миров, что ограничивает время возможного пребывания человека в среде ДР \cite{sns_tras}.

\section*{Вывод}

В данном разделе была изучена предметная область, обоснована актуальность задачи, описаны основные определения ДР, компьютерного зрения, моделей освещения и наложения теней, был проведен обзор существующих методов получения данных о глубине окружения, моделей освещения и способов построения теней, а также определены сложности решения задачи наложения теней в ДР.